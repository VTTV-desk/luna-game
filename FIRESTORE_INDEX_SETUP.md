# 🔥 Firestore 인덱스 설정 가이드

## ✅ 확장 가능한 리더보드 시스템 업데이트 완료!

새로운 시스템은 **`players` 컬렉션**을 사용하여 각 플레이어의 최고 점수만 관리합니다.

---

## 📊 새로운 데이터 구조

### 1️⃣ **scores 컬렉션** (모든 게임 기록 - 히스토리용)
```
scores/
├─ {auto-id}: {
│    player_id: "user_abc123",
│    player_name: "익명",
│    score: 1200,
│    candies: 120,
│    monsters_killed: 50,
│    timestamp: 2025-01-29T12:00:00Z,
│    date: "2025-01-29"
│  }
```

### 2️⃣ **players 컬렉션** (플레이어별 최고 점수 - 리더보드용) ⭐
```
players/
├─ {player_id}: {
│    player_id: "user_abc123",
│    player_name: "익명",
│    best_score: 1500,        ← 최고 점수만 저장
│    candies: 150,
│    monsters_killed: 60,
│    total_games: 25,          ← 총 게임 횟수
│    first_played: timestamp,
│    last_played: timestamp
│  }
```

---

## 🔧 필수 Firestore 인덱스 생성

**players 컬렉션에서 best_score 기준 정렬을 위한 인덱스가 필요합니다.**

### ✅ 자동 인덱스 생성 (권장)

1. **게임을 플레이**하고 점수를 기록하세요.
2. Firebase Console에서 **자동으로 인덱스 생성 제안**이 나타납니다.
3. 제안된 인덱스 링크를 클릭하면 자동으로 생성됩니다.

---

### 🛠️ 수동 인덱스 생성 (선택사항)

Firebase Console에서 직접 인덱스를 생성하려면:

1. **Firebase Console** 접속: https://console.firebase.google.com/
2. 프로젝트 선택
3. **Firestore Database** → **인덱스** 탭
4. **단일 필드 인덱스 생성** 클릭
5. 다음 설정 입력:
   - **컬렉션 ID**: `players`
   - **필드**: `best_score`
   - **쿼리 범위**: `Collection`
   - **정렬**: `Descending` (내림차순)
6. **만들기** 클릭

**인덱스 생성 시간**: 약 1-2분 소요

---

## ⚡ 성능 개선 효과

### 이전 시스템 (비효율적)
```
❌ scores 컬렉션에서 100개 기록 가져오기
❌ 메모리에서 플레이어별 최고 점수 필터링
❌ 정렬 후 TOP 10만 반환
❌ 10,000명 × 1,000번 = 10,000,000개 기록 처리 불가
```

### 새 시스템 (확장 가능)
```
✅ players 컬렉션에서 직접 TOP 10만 가져오기
✅ 이미 플레이어별 최고 점수만 저장됨
✅ Firebase 인덱스로 빠른 정렬
✅ 10,000명 플레이어 = 10,000개 문서만 처리
✅ 100만 플레이어도 문제없음!
```

---

## 📈 확장성 비교

| 시나리오 | 이전 시스템 | 새 시스템 |
|---------|------------|----------|
| 10명 × 10번 게임 | 100개 읽기 ❌ | 10개 읽기 ✅ |
| 100명 × 100번 게임 | 10,000개 읽기 ❌ | 100개 읽기 ✅ |
| 10,000명 × 1,000번 게임 | 불가능 ❌ | 10,000개 읽기 ✅ |
| 100만명 플레이어 | 불가능 ❌ | 100만개 읽기 ✅ |

---

## 🎮 게임 플레이 확인

1. 게임을 플레이하고 점수를 기록하세요
2. 리더보드를 확인하세요
3. 콘솔 로그에서 다음 메시지를 확인하세요:
   ```
   🔥 Score added to Firebase
   🆕 New player created: 익명 (1200)
   또는
   🏆 New best score for 익명: 800 → 1200
   ```

4. Firebase Console → Firestore에서 **players 컬렉션**이 생성되었는지 확인하세요

---

## ⚠️ 주의사항

- **첫 플레이 시** 인덱스가 생성되지 않아 오류가 발생할 수 있습니다
- Firebase Console에서 **인덱스 생성 제안 링크**를 클릭하여 생성하세요
- 인덱스 생성 후 1-2분 기다리면 정상 작동합니다

---

## 🎯 시스템 작동 원리

### 게임 종료 시:
1. **scores 컬렉션**에 게임 기록 추가 (히스토리)
2. **players/{player_id}** 문서 확인:
   - 새 플레이어면 → 문서 생성
   - 기존 플레이어면 → 최고 점수 비교 후 업데이트

### 리더보드 조회 시:
1. **players 컬렉션**에서 `best_score` 기준 내림차순 정렬
2. 상위 10명만 가져오기
3. 즉시 화면에 표시

---

## ✅ 완료!

이제 시스템이 **10,000명이 1,000번씩 플레이해도 문제없이** 작동합니다!

게임을 플레이하고 새로운 시스템을 테스트해보세요! 🎮✨
